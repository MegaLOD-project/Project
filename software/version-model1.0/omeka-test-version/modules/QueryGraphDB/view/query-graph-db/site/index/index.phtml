<?php
$results = $this->results;
$currentSubjectFilter = $_GET['subject'] ?? null;
$currentSecondaryFilters = $_GET['filters'] ?? [];
?>

<div class="container">
    <div class="filter-column">
        <h2>Filtros</h2>
        <nav class="filter-menu">
            <form method="get" action="<?php echo $this->url(null, [], [], true); ?>" id="filter-form">
                <div class="filter-group">
                    <div class="filter-header">
                        Subject
                    </div>
                    <ul class="filter-list open">
                        <li>
                            <label class="filter-label">
                                <input type="radio" name="subject" value="all" <?php if (!$currentSubjectFilter): ?>checked<?php endif; ?> onchange="submitForm()">
                                Todos
                            </label>
                        </li>
                        <li>
                            <label class="filter-label">
                                <input type="radio" name="subject" value="arrowheads" <?php if ($currentSubjectFilter === 'arrowheads'): ?>checked<?php endif; ?> onchange="submitForm()">
                                Arrowheads
                            </label>
                        </li>
                        <li>
                            <label class="filter-label">
                                <input type="radio" name="subject" value="axes" <?php if ($currentSubjectFilter === 'axes'): ?>checked<?php endif; ?> onchange="submitForm()">
                                Axes
                            </label>
                        </li>
                        <li>
                            <label class="filter-label">
                                <input type="radio" name="subject" value="excavations" <?php if ($currentSubjectFilter === 'excavations'): ?>checked<?php endif; ?> onchange="submitForm()">
                                Excavations
                            </label>
                        </li>
                        <li>
                            <label class="filter-label">
                                <input type="radio" name="subject" value="archaeologists" <?php if ($currentSubjectFilter === 'archaeologists'): ?>checked<?php endif; ?> onchange="submitForm()">
                                Archaeologists
                            </label>
                        </li>
                    </ul>
                </div>

                <div id="secondary-filters-container">
                    <?php if ($currentSubjectFilter === 'arrowheads'): ?>
                        <div class="filter-group">
                            <div class="filter-header" onclick="toggleFilters('shape-filters')">
                                <i class="arrow"></i> Shape
                            </div>
                            <ul class="filter-list" id="shape-filters">
                                <li>
                                    <label class="filter-label">
                                        <input type="checkbox" name="filters[shape][]" value="triangle" <?php if (isset($currentSecondaryFilters['shape']) && in_array('triangle', $currentSecondaryFilters['shape'])): ?>checked<?php endif; ?> onchange="submitForm()">
                                        Triangle
                                    </label>
                                </li>
                                <li>
                                    <label class="filter-label">
                                        <input type="checkbox" name="filters[shape][]" value="losangular" <?php if (isset($currentSecondaryFilters['shape']) && in_array('losangular', $currentSecondaryFilters['shape'])): ?>checked<?php endif; ?> onchange="submitForm()">
                                        Losangular
                                    </label>
                                </li>
                                <li>
                                    <label class="filter-label">
                                        <input type="checkbox" name="filters[shape][]" value="pedunculated" <?php if (isset($currentSecondaryFilters['shape']) && in_array('pedunculated', $currentSecondaryFilters['shape'])): ?>checked<?php endif; ?> onchange="submitForm()">
                                        Pedunculated
                                    </label>
                                </li>
                            </ul>
                        </div>

                        <div class="filter-group">
                            <div class="filter-header" onclick="toggleFilters('variant-filters')">
                                <i class="arrow"></i> Variant
                            </div>
                            <ul class="filter-list" id="variant-filters">
                                <li>
                                    <label class="filter-label">
                                        <input type="checkbox" name="filters[variant][]" value="flat" <?php if (isset($currentSecondaryFilters['variant']) && in_array('flat', $currentSecondaryFilters['variant'])): ?>checked<?php endif; ?> onchange="submitForm()">
                                        Flat
                                    </label>
                                </li>
                                <li>
                                    <label class="filter-label">
                                        <input type="checkbox" name="filters[variant][]" value="raised" <?php if (isset($currentSecondaryFilters['variant']) && in_array('raised', $currentSecondaryFilters['variant'])): ?>checked<?php endif; ?> onchange="submitForm()">
                                        Raised
                                    </label>
                                </li>
                                <li>
                                    <label class="filter-label">
                                        <input type="checkbox" name="filters[variant][]" value="thick" <?php if (isset($currentSecondaryFilters['variant']) && in_array('thick', $currentSecondaryFilters['variant'])): ?>checked<?php endif; ?> onchange="submitForm()">
                                        Thick
                                    </label>
                                </li>
                            </ul>
                        </div>

                        <div class="filter-group">
                            <div class="filter-header" onclick="toggleFilters('point-filters')">
                                <i class="arrow"></i> Has Point
                            </div>
                            <ul class="filter-list" id="point-filters">
                                <li>
                                    <label class="filter-label">
                                        <input type="checkbox" name="filters[point][]" value="true" <?php if (isset($currentSecondaryFilters['point']) && in_array('true', $currentSecondaryFilters['point'])): ?>checked<?php endif; ?> onchange="submitForm()">
                                        True
                                    </label>
                                </li>
                                <li>
                                    <label class="filter-label">
                                        <input type="checkbox" name="filters[point][]" value="false" <?php if (isset($currentSecondaryFilters['point']) && in_array('false', $currentSecondaryFilters['point'])): ?>checked<?php endif; ?> onchange="submitForm()">
                                        False
                                    </label>
                                </li>
                            </ul></label>
                        </div>

                        <div class="filter-group">
                            <div class="filter-header" onclick="toggleFilters('body-filters')">
                                <i class="arrow"></i> Has Body
                            </div>
                            <ul class="filter-list" id="body-filters">
                                <li>
                                    <label class="filter-label">
                                        <input type="checkbox" name="filters[body][]" value="true" <?php if (isset($currentSecondaryFilters['body']) && in_array('true', $currentSecondaryFilters['body'])): ?>checked<?php endif; ?> onchange="submitForm()">
                                        True
                                    </label>
                                </li>
                                <li>
                                    <label class="filter-label">
                                        <input type="checkbox" name="filters[body][]" value="false" <?php if (isset($currentSecondaryFilters['body']) && in_array('false', $currentSecondaryFilters['body'])): ?>checked<?php endif; ?> onchange="submitForm()">
                                        False
                                    </label>
                                </li>
                            </ul></label>
                        </div>

                        <div class="filter-group">
                            <div class="filter-header" onclick="toggleFilters('base-filters')">
                                <i class="arrow"></i> Base
                            </div>
                            <ul class="filter-list" id="base-filters">
                                <li>
                                    <label class="filter-label">
                                        <input type="checkbox" name="filters[base][]" value="straight" <?php if (isset($currentSecondaryFilters['base']) && in_array('straight', $currentSecondaryFilters['base'])): ?>checked<?php endif; ?> onchange="submitForm()">
                                        Straight
                                    </label>
                                </li>
                                <li>
                                    <label class="filter-label">
                                        <input type="checkbox" name="filters[base][]" value="convex" <?php if (isset($currentSecondaryFilters['base']) && in_array('convex', $currentSecondaryFilters['base'])): ?>checked<?php endif; ?> onchange="submitForm()">
                                        Convex
                                    </label>
                                </li>
                                <li>
                                    <label class="filter-label">
                                        <input type="checkbox" name="filters[base][]" value="concave" <?php if (isset($currentSecondaryFilters['base']) && in_array('concave', $currentSecondaryFilters['base'])): ?>checked<?php endif; ?> onchange="submitForm()">
                                        Concave
                                    </label>
                                </li>
                                <li>
                                    <label class="filter-label">
                                        <input type="checkbox" name="filters[base][]" value="pedunculated" <?php if (isset($currentSecondaryFilters['base']) && in_array('pedunculated', $currentSecondaryFilters['base'])): ?>checked<?php endif; ?> onchange="submitForm()">
                                        Pedunculated
                                    </label>
                                </li>
                                <li>
                                    <label class="filter-label">
                                        <input type="checkbox" name="filters[base][]" value="triangular" <?php if (isset($currentSecondaryFilters['base']) && in_array('triangular', $currentSecondaryFilters['base'])): ?>checked<?php endif; ?> onchange="submitForm()">
                                        Triangular
                                    </label>
                                </li>
                            </ul>
                        </div>

                        <div class="filter-group">
                            <div class="filter-header" onclick="toggleFilters('mode-filters')">
                                <i class="arrow"></i> Chipping Mode
                            </div>
                            <ul class="filter-list" id="mode-filters">
                                <li>
                                    <label class="filter-label">
                                        <input type="checkbox" name="filters[mode][]" value="plane" <?php if (isset($currentSecondaryFilters['mode']) && in_array('plane', $currentSecondaryFilters['mode'])): ?>checked<?php endif; ?> onchange="submitForm()">
                                        Plane
                                    </label>
                                </li>
                                <li>
                                    <label class="filter-label">
                                        <input type="checkbox" name="filters[mode][]" value="parallel" <?php if (isset($currentSecondaryFilters['mode']) && in_array('parallel', $currentSecondaryFilters['mode'])): ?>checked<?php endif; ?> onchange="submitForm()">
                                        Parallel
                                    </label>
                                </li>
                                <li>
                                    <label class="filter-label">
                                        <input type="checkbox" name="filters[mode][]" value="sub-parallel" <?php if (isset($currentSecondaryFilters['mode']) && in_array('sub-parallel', $currentSecondaryFilters['mode'])): ?>checked<?php endif; ?> onchange="submitForm()">
                                        Sub-parallel
                                    </label>
                                </li>
                            </ul>
                        </div>

                        <div class="filter-group">
                            <div class="filter-header" onclick="toggleFilters('amplitude-filters')">
                                <i class="arrow"></i> Chipping Amplitude
                            </div>
                            <ul class="filter-list" id="amplitude-filters">
                                <li>
                                    <label class="filter-label">
                                        <input type="checkbox" name="filters[amplitude][]" value="true" <?php if (isset($currentSecondaryFilters['amplitude']) && in_array('true', $currentSecondaryFilters['amplitude'])): ?>checked<?php endif; ?> onchange="submitForm()">
                                        True
                                    </label>
                                </li>
                                <li>
                                    <label class="filter-label">
                                        <input type="checkbox" name="filters[amplitude][]" value="false" <?php if (isset($currentSecondaryFilters['amplitude']) && in_array('false', $currentSecondaryFilters['amplitude'])): ?>checked<?php endif; ?> onchange="submitForm()">
                                        False
                                    </label>
                                </li>
                            </ul></label>
                        </div>

                        <div class="filter-group">
                            <div class="filter-header" onclick="toggleFilters('direction-filters')">
                                <i class="arrow"></i> Chipping Direction
                            </div>
                            <ul class="filter-list" id="direction-filters">
                                <li>
                                    <label class="filter-label">
                                        <input type="checkbox" name="filters[direction][]" value="direct" <?php if (isset($currentSecondaryFilters['direction']) && in_array('direct', $currentSecondaryFilters['direction'])): ?>checked<?php endif; ?> onchange="submitForm()">
                                        Direct
                                    </label>
                                </li>
                                <li>
                                    <label class="filter-label">
                                        <input type="checkbox" name="filters[direction][]" value="reverse" <?php if (isset($currentSecondaryFilters['direction']) && in_array('reverse', $currentSecondaryFilters['direction'])): ?>checked<?php endif; ?> onchange="submitForm()">
                                        Reverse
                                    </label>
                                </li>
                                <li>
                                    <label class="filter-label">
                                        <input type="checkbox" name="filters[direction][]" value="bifacial" <?php if (isset($currentSecondaryFilters['direction']) && in_array('bifacial', $currentSecondaryFilters['bifacial'])): ?>checked<?php endif; ?> onchange="submitForm()">
                                        Bifacial
                                    </label>
                                </li>
                            </ul>
                        </div>

                        <div class="filter-group">
                            <div class="filter-header" onclick="toggleFilters('orientation-filters')">
                                <i class="arrow"></i> Chipping Orientation
                            </div>
                            <ul class="filter-list" id="orientation-filters">
                                <li>
                                    <label class="filter-label">
                                        <input type="checkbox" name="filters[orientation][]" value="true" <?php if (isset($currentSecondaryFilters['orientation']) && in_array('true', $currentSecondaryFilters['orientation'])): ?>checked<?php endif; ?> onchange="submitForm()">
                                        True
                                    </label>
                                </li>
                                <li>
                                    <label class="filter-label">
                                        <input type="checkbox" name="filters[orientation][]" value="false" <?php if (isset($currentSecondaryFilters['orientation']) && in_array('false', $currentSecondaryFilters['orientation'])): ?>checked<?php endif; ?> onchange="submitForm()">
                                        False
                                    </label>
                                </li>
                            </ul></label>
                        </div>

                        <div class="filter-group">
                            <div class="filter-header" onclick="toggleFilters('delineation-filters')">
                                <i class="arrow"></i> Chipping Delineation
                            </div>
                            <ul class="filter-list" id="delineation-filters">
                                <li>
                                    <label class="filter-label">
                                        <input type="checkbox" name="filters[delineation][]" value="continuous" <?php if (isset($currentSecondaryFilters['delineation']) && in_array('continuous', $currentSecondaryFilters['delineation'])): ?>checked<?php endif; ?> onchange="submitForm()">
                                        Continuous
                                    </label>
                                </li>
                                <li>
                                    <label class="filter-label">
                                        <input type="checkbox" name="filters[delineation][]" value="composite" <?php if (isset($currentSecondaryFilters['delineation']) && in_array('composite', $currentSecondaryFilters['delineation'])): ?>checked<?php endif; ?> onchange="submitForm()">
                                        Composite
                                    </label>
                                </li>
                                <li>
                                    <label class="filter-label">
                                        <input type="checkbox" name="filters[delineation][]" value="denticulated" <?php if (isset($currentSecondaryFilters['delineation']) && in_array('denticulated', $currentSecondaryFilters['delineation'])): ?>checked<?php endif; ?> onchange="submitForm()">
                                        Denticulated
                                    </label>
                                </li>
                            </ul>
                        </div>

                        <div class="filter-group">
                            <div class="filter-header" onclick="toggleFilters('chippinglocation-side-filters')">
                                <i class="arrow"></i> Chipping Location - Side
                            </div>
                            <ul class="filter-list" id="chippinglocation-side-filters">
                                <li>
                                    <label class="filter-label">
                                        <input type="checkbox" name="filters[chippinglocation-Side][]" value="distal" <?php if (isset($currentSecondaryFilters['chippinglocation-Side']) && in_array('distal', $currentSecondaryFilters['chippinglocation-Side'])): ?>checked<?php endif; ?> onchange="submitForm()">
                                        Distal
                                    </label>
                                </li>
                                <li>
                                    <label class="filter-label">
                                        <input type="checkbox" name="filters[chippinglocation-Side][]" value="median" <?php if (isset($currentSecondaryFilters['chippinglocation-Side']) && in_array('median', $currentSecondaryFilters['chippinglocation-Side'])): ?>checked<?php endif; ?> onchange="submitForm()">
                                        Median
                                    </label>
                                </li>
                                <li>
                                    <label class="filter-label">
                                        <input type="checkbox" name="filters[chippinglocation-Side][]" value="proximal" <?php if (isset($currentSecondaryFilters['chippinglocation-Side']) && in_array('proximal', $currentSecondaryFilters['chippinglocation-Side'])): ?>checked<?php endif; ?> onchange="submitForm()">
                                        Proximal
                                    </label>
                                </li>
                            </ul>
                        </div>

                        <div class="filter-group">
                            <div class="filter-header" onclick="toggleFilters('chippinglocation-transversal-filters')">
                                <i class="arrow"></i> Chipping Location - Transversal
                            </div>
                            <ul class="filter-list" id="chippinglocation-transversal-filters">
                                <li>
                                    <label class="filter-label">
                                        <input type="checkbox" name="filters[chippinglocation-Transversal][]" value="distal" <?php if (isset($currentSecondaryFilters['chippinglocation-Transversal']) && in_array('distal', $currentSecondaryFilters['chippinglocation-Transversal'])): ?>checked<?php endif; ?> onchange="submitForm()">
                                        Distal
                                    </label>
                                </li>
                                <li>
                                    <label class="filter-label">
                                        <input type="checkbox" name="filters[chippinglocation-Transversal][]" value="median" <?php if (isset($currentSecondaryFilters['chippinglocation-Transversal']) && in_array('median', $currentSecondaryFilters['chippinglocation-Transversal'])): ?>checked<?php endif; ?> onchange="submitForm()">
                                        Median
                                    </label>
                                </li>
                                <li>
                                    <label class="filter-label">
                                        <input type="checkbox" name="filters[chippinglocation-Transversal][]" value="proximal" <?php if (isset($currentSecondaryFilters['chippinglocation-Transversal']) && in_array('proximal', $currentSecondaryFilters['chippinglocation-Transversal'])): ?>checked<?php endif; ?> onchange="submitForm()">
                                        Proximal
                                    </label>
                                </li>
                            </ul>
                        </div>

                        <div class="filter-group">
                            <div class="filter-header" onclick="toggleFilters('chippingshape-filters')">
                                <i class="arrow"></i> Chipping Shape
                            </div>
                            <ul class="filter-list" id="chippingshape-filters">
                                <li>
                                    <label class="filter-label">
                                        <input type="checkbox" name="filters[chippingShape][]" value="straight" <?php if (isset($currentSecondaryFilters['chippingShape']) && in_array('straight', $currentSecondaryFilters['chippingShape'])): ?>checked<?php endif; ?> onchange="submitForm()">
                                        Straight
                                    </label>
                                </li>
                                <li>
                                    <label class="filter-label">
                                        <input type="checkbox" name="filters[chippingShape][]" value="convex" <?php if (isset($currentSecondaryFilters['chippingShape']) && in_array('convex', $currentSecondaryFilters['chippingShape'])): ?>checked<?php endif; ?> onchange="submitForm()">
                                        Convex
                                    </label>
                                </li>
                                <li>
                                    <label class="filter-label">
                                        <input type="checkbox" name="filters[chippingShape][]" value="concave" <?php if (isset($currentSecondaryFilters['chippingShape']) && in_array('concave', $currentSecondaryFilters['chippingShape'])): ?>checked<?php endif; ?> onchange="submitForm()">
                                        Concave
                                    </label>
                                </li>
                                <li>
                                    <label class="filter-label">
                                        <input type="checkbox" name="filters[chippingShape][]" value="sinuous" <?php if (isset($currentSecondaryFilters['chippingShape']) && in_array('sinuous', $currentSecondaryFilters['chippingShape'])): ?>checked<?php endif; ?> onchange="submitForm()">
                                        Sinuous
                                    </label>
                                </li>
                            </ul>
                        </div>


                    <?php elseif ($currentSubjectFilter === 'axes'): ?>
                    <?php elseif ($currentSubjectFilter === 'excavations'): ?>
                    <?php endif; ?>
                </div>

                <button type="button" onclick="clearSecondaryFilters()" class="filter-button">Limpar Filtros</button>
            </form>
        </nav>
    </div>

    <div class="results-column">
        <h2>Resultados da Consulta ao GraphDB</h2>
        <?php if (isset($results['results']['bindings']) && !empty($results['results']['bindings'])): ?>
            <ul class="results-list">
                <?php foreach ($results['results']['bindings'] as $row): ?>
                    <li><?php echo htmlspecialchars($row['object']['value']); ?></li>
                <?php endforeach; ?>
            </ul>
        <?php else: ?>
            <p class="no-results">Nenhum resultado encontrado.</p>
        <?php endif; ?>
    </div>
</div>


<style>
    .container {
        display: flex;
        width: 100%;
        max-width: 1200px; /* Adjust as needed */
        margin: 0 auto;
        font-family: sans-serif;
        color: black;
    }

    .filter-column {
        width: 300px;
        padding-right: 20px;
        border-right: 1px solid #ddd;
    }

    .results-column {
        flex: 1;
        padding-left: 20px;
    }

    .filter-menu {
        border: 1px solid #ddd;
        padding: 10px;
        margin-bottom: 20px;
        background-color: #f9f9f9;
        border-radius: 5px;
    }

    .filter-group {
        margin-bottom: 10px;
    }

    .filter-header {
        cursor: pointer;
        padding: 10px;
        background-color: #eee;
        border-bottom: 1px solid #ddd;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-radius: 5px 5px 0 0;
    }

    

    .filter-header .arrow {
        width: 0;
        height: 0;
        border-left: 5px solid transparent;
        border-right: 5px solid transparent;
        border-top: 5px solid #555;
        margin-right: 5px;
        transition: transform 0.2s ease-in-out;
    }

    .filter-header.active .arrow {
        transform: rotate(-90deg);
    }

    .filter-list {
        list-style: none;
        padding-left: 15px;
        display: none;
        background-color: white;
        padding-bottom: 10px;
        border-radius: 0 0 5px 5px;
    }

    .filter-list.open {
        display: block;
    }

    .filter-list li {
        margin-bottom: 5px;
    }

    .filter-label {
        display: block;
        cursor: pointer;
        padding: 5px 0;
    }

    .filter-button {
        background-color: #4CAF50;
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
    }

    .filter-button:hover {
        background-color: #3e8e41;
    }

    .results-list {
        list-style-type: none;
        padding-left: 0;
    }

    .results-list li::before {
        content: "\2022";
        color: #555;
        display: inline-block;
        width: 1em;
        margin-left: -1em;
    }

    .no-results {
        font-style: italic;
        color: #888;
    }
</style>

<script>
    function toggleFilters(id) {
        const filterList = document.getElementById(id);
        const filterHeader = filterList.previousElementSibling;
        filterList.classList.toggle('open');
        filterHeader.classList.toggle('active');
    }

    function clearSecondaryFilters() {
        const secondaryFiltersContainer = document.getElementById('secondary-filters-container');
        if (secondaryFiltersContainer) {
            const checkboxes = secondaryFiltersContainer.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            const textInputs = secondaryFiltersContainer.querySelectorAll('input[type="text"]');
            textInputs.forEach(input => {
                input.value = '';
            });
            // Submit the form to apply the cleared filters
            document.getElementById('filter-form').submit();
        }
    }

    function submitForm() {
        document.getElementById('filter-form').submit();
    }

    // Keep filter groups open if they have selected items on page load
    document.addEventListener('DOMContentLoaded', function() {
        const filterGroups = document.querySelectorAll('.filter-group');
        filterGroups.forEach(group => {
            const checkboxes = group.querySelectorAll('input[type="checkbox"]:checked');
            const textInputs = group.querySelectorAll('input[type="text"][value!=""]');
            if (checkboxes.length > 0 || textInputs.length > 0) {
                const filterList = group.querySelector('.filter-list');
                const filterHeader = group.querySelector('.filter-header');
                if (filterList && filterHeader) {
                    filterList.classList.add('open');
                    filterHeader.classList.add('active');
                }
            }
        });

        // Ensure the correct secondary filters are visible on initial load
        const initialSubject = document.querySelector('input[name="subject"]:checked');
        if (initialSubject && initialSubject.value !== 'all') {
            // The secondary filters for the initially selected subject are already rendered
            // by the PHP in this non-AJAX example.
        }
    });
</script>